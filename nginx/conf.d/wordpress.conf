map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}
map $http_cookie $skip_cache {
  default 0;
  ~*WordPress_logged_in_ 1;
  ~*comment_author_      1;
  ~*woocommerce_items_in_cart 1;
  ~*woocommerce_cart_hash 1;
}

server {
  listen 80;
  # Accept Cloudflare Zero Trust host headers plus any future hostnames.
  server_name _ filesharing.dongchenxie.com localhost 127.0.0.1;
  root /var/www/html;
  index index.php;

  location = /healthz { return 200 "ok\n"; }

  client_max_body_size 64m;
  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options SAMEORIGIN always;
  add_header Referrer-Policy strict-origin-when-cross-origin always;

  location ~ /\. { deny all; }
  location ~* /(\.git|\.svn|\.hg)/ { deny all; }

  # Block XML-RPC if not needed
  location = /xmlrpc.php { return 403; }

  location ~* \.(?:css|js|jpg|jpeg|gif|png|svg|webp|ico|ttf|otf|eot|woff|woff2)$ {
    expires 30d;
    access_log off;
    add_header Cache-Control "public, max-age=2592000, immutable";
    try_files $uri =404;
  }

  location / {
    try_files $uri $uri/ /index.php?$args;
  }

  location ~ \.php$ {
    try_files $uri =404;

    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

    fastcgi_pass wordpress:9000;
    fastcgi_read_timeout 120;
    fastcgi_send_timeout 60;
    fastcgi_connect_timeout 60;

    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;

    # Microcaching (optional): uncomment after verifying login flows
    # if ($request_method !~ ^(GET|HEAD)$) { set $skip_cache 1; }
    # fastcgi_no_cache $skip_cache;
    # fastcgi_cache_bypass $skip_cache;
    # fastcgi_cache WORDPRESS;
    # fastcgi_cache_valid 200 301 302 10s;
    # add_header X-Cache-Status $upstream_cache_status;
  }

  location ~* /(?:uploads|files)/.*\.php$ { deny all; }
}
